name: Update Followers

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch followers
        env:
          YT_API_KEY: ${{ secrets.YT_API_KEY }}
        run: |
          python3 << 'EOF'
          import json
          import re
          import requests
          import datetime
          import os

          YT_API_KEY = os.getenv("YT_API_KEY", "")
          if not YT_API_KEY:
              raise SystemExit("Missing secret: YT_API_KEY (check repo Settings > Secrets and variables > Actions)")


          # --- YOUTUBE ---
          yt_url = "https://www.googleapis.com/youtube/v3/channels"
          yt_params = {
              "part": "statistics",
              "id": "UCbVtsiAIvqalXK60M7r-EBw",
              "key": YT_API_KEY
          }
          yt = requests.get(yt_url, params=yt_params).json()
          youtube = int(yt["items"][0]["statistics"]["subscriberCount"])

          # --- INSTAGRAM ---
          ig_resp = requests.get(
              "https://www.instagram.com/sealand_watches/",
              headers={"User-Agent": "Mozilla/5.0", "Accept-Language": "en-US,en;q=0.9"}
          )
          print("IG status:", ig_resp.status_code)
          print("IG first 300 chars:", ig_resp.text[:300])
          ig_html = ig_resp.text
          
          # --- TIKTOK ---
          tt_resp = requests.get(
            "https://www.tiktok.com/@sealandwatches",
            headers={"User-Agent": "Mozilla/5.0", "Accept-Language": "en-US,en;q=0.9"}
          )
          print("TT status:", tt_resp.status_code)
          print("TT first 300 chars:", tt_resp.text[:300])
          tt_html = tt_resp.text

          data = {
              "youtube": youtube,
              "instagram": instagram,
              "tiktok": tiktok,
              "updatedAt": datetime.datetime.utcnow().isoformat() + "Z"
          }

          with open("followers.json", "w") as f:
              json.dump(data, f, indent=2)

          print(data)
          EOF

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add followers.json
          git commit -m "Auto-update followers" || exit 0
          git push
